
<!DOCTYPE html>
<html lang="en" class=" is-copy-enabled">
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
    <meta charset="utf-8">

    <link id="favicon" rel="icon" type="image/png" href="clock.png">

    <title>Pomos</title>

    <link rel="stylesheet" href="bootstrap.min.css">

    <style>

      html {
        background: -moz-linear-gradient(top,  rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%); /* FF3.6+ */
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(255,255,255,1)), color-stop(100%,rgba(255,255,255,0))); /* Chrome,Safari4+ */
        background: -webkit-linear-gradient(top,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* Chrome10+,Safari5.1+ */
        background: -o-linear-gradient(top,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* Opera 11.10+ */
        background: -ms-linear-gradient(top,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* IE10+ */
        background: linear-gradient(to bottom,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* W3C */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#00ffffff',GradientType=0 ); /* IE6-9 */

        height: 100%;
      }

      #timer {
        margin-top: 20px;
        text-align: center;
        font-size: 100pt;
        font-weight: bold;
        height: 180px;
        padding: 20px;
      }

      li {
        display: inline-block;
        margin: 10px;
      }

      ul {
        list-style: none;
      }

      #buttons {
        text-align: center;
        margin-top: 50px;
        margin-bottom: 50px;
      }
    </style>

    <script type="text/javascript" src="jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="knockout-3.3.0.js"></script>

    <script type="text/javascript">

      function drawFavicon(value) {
  			var link = document.querySelector("link[rel~='icon']");

  			if (!link) {
  			  link = document.createElement("link");
  			  link.setAttribute("rel", "shortcut icon");
  			  document.head.appendChild(link);
  			}

  			var faviconUrl = link.href || window.location.origin + "/favicon.ico";

  			function onImageLoaded() {
  			  var canvas = document.createElement("canvas");
  			  canvas.width = 16;
  			  canvas.height = 16;
  			  var context = canvas.getContext("2d");
  			  context.font="12px Verdana";
  			  context.fillText(value, 0, 12);
  			  context.fill();
  			  link.type = "image/x-icon";
  			  link.href = canvas.toDataURL();
  			};

  			var img = document.createElement("img");
  			img.addEventListener("load", onImageLoaded);
  			img.src = faviconUrl;
  		};

		  function resetFavicon() {
			     $("#favicon").attr('href', 'clock.png');
      };

      function pad(n, width, z) {
        z = z || '0';
        n = n + '';
        return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
      };

      var mainViewModel = function(window) {
        var self = this;

        self.content = ko.observable('');

        self.mode = ko.observable('');

        self.minutes = 0;
        self.seconds = 0;

        self.interval = null;

        self.startPomodoro = function () {
          self.mode = 'pomodoro';
          self.minutes = 25;
          self.seconds = 0;

          self.startTicking();
        };

        self.startShortBreak = function() {
          self.mode = 'short';
          self.minutes = 5;
          self.seconds = 0;

          self.startTicking();
        };

        self.startLongBreak = function() {
          self.mode = 'long';
          self.minutes = 15;
          self.seconds = 0;

          self.startTicking();
        };

        self.stop = function() {
          self.mode = '';
          self.minutes = 0;
          self.seconds = 0;

          self.stopTicking();
        };

        self.startTicking = function() {
          self.sendNotification('Started ' + self.mode, 'Left: ' + self.minutes + ' minutes');

          self.updateContent();

          if (self.interval != null) {
            clearInterval(self.interval);
          }

          self.interval = setInterval(self.tick, 1000);
        };

        self.stopTicking = function() {
          clearInterval(self.interval);
          self.updateContent();
          resetFavicon();

        };

        self.tick = function() {
          if (self.mode != '') {
            self.seconds -= 1;

            if (self.seconds < 0) {
              self.seconds = 59;
              self.minutes -= 1;
            }

            if (self.minutes < 0) {
              self.finished();
              return;
            }

            if (self.minutes > 0) {
              drawFavicon(self.minutes);
            } else {
              drawFavicon(self.seconds);
            }

            if (self.minutes == 10 && self.seconds == 59) {
              self.sendNotification('Started ' + self.mode, 'Left: ' + self.minutes + ' minutes');
            }

            self.updateContent();
          }
        };

        self.finished = function() {
          self.sendNotification('Finished ' + self.mode + '!', '');

          self.mode = '';
          self.minutes = 0;
          self.seconds = 0;

          self.stopTicking();
        };

        self.updateContent = function() {
          if (self.mode == '') {
            self.content('');
          } else {
            self.content(pad(self.minutes, 2) + ':' + pad(self.seconds, 2));
          }
        };

        self.sendNotification = function(title, text) {
          if (!Notification) {
            alert('Desktop notifications not available in your browser. Try Chromium.');
            return;
          }

          if (Notification.permission !== "granted")
            Notification.requestPermission();
          else {
            var notification = new Notification(title, {
              icon: 'clock-mini.png',
              body: text,
            });
          }
        }

        return self;
      }();

      document.addEventListener('DOMContentLoaded', function () {
        if (Notification.permission !== "granted")
          Notification.requestPermission();
      });
    </script>

  </head>

  <body>
    <div id="main">
      <div id="timer" data-bind="text: content"></div>

      <div id="buttons">
        <ul>
          <li><button class="btn btn-info btn-lg" data-bind="click: startPomodoro">Start pomodoro</button></li>
          <li><button class="btn btn-info btn-lg" data-bind="click: startShortBreak">Start short break</button></li>
          <li><button class="btn btn-info btn-lg" data-bind="click: startLongBreak">Start long break</button></li>
          <li><button class="btn btn-info btn-lg" data-bind="click: stop">Stop</button></li>
        </ul>
      </buttons>
    </div>

    <script type="text/javascript">
      ko.applyBindings(mainViewModel);
    </script>
  </body>
</html>
